PUSH SERVICE ARCHITECTURE â€” TEMPLATE INTEGRATION DIAGRAM

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  API GATEWAY                                                                â”‚
â”‚  â”œâ”€ Receives notification request                                          â”‚
â”‚  â”œâ”€ Validates & authenticates                                              â”‚
â”‚  â””â”€ Publishes event to RabbitMQ / push.queue                               â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â”‚ Event JSON (snake_case):                                            â”‚
â”‚      â”‚ {                                                                   â”‚
â”‚      â”‚   "event_id": "evt-123",                                            â”‚
â”‚      â”‚   "user_id": 42,                                                    â”‚
â”‚      â”‚   "template_code": "welcome_v1" OR "payload": {...}                 â”‚
â”‚      â”‚ }                                                                   â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  RABBITMQ QUEUE  â”‚                                                       â”‚
â”‚  â”‚  push.queue      â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â”‚ async dequeue                                             â”‚        â”‚
â”‚      â–¼                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚           PUSH SERVICE WORKER                           â”‚    â”‚        â”‚
â”‚  â”‚  (core/worker.py - process_push_event)                 â”‚    â”‚        â”‚
â”‚  â”‚                                                         â”‚    â”‚        â”‚
â”‚  â”‚  1. Parse & validate event                             â”‚    â”‚        â”‚
â”‚  â”‚  2. âœ… Idempotency check (Redis key)                   â”‚    â”‚        â”‚
â”‚  â”‚  3. âœ… Fetch device token (User Service or Redis)      â”‚    â”‚        â”‚
â”‚  â”‚  4. âœ… Rate limit check (Redis counter)                â”‚    â”‚        â”‚
â”‚  â”‚  5. âœ… Circuit breaker check (FCM provider)            â”‚    â”‚        â”‚
â”‚  â”‚  6. ðŸ†• RESOLVE PAYLOAD:                                â”‚    â”‚        â”‚
â”‚  â”‚     â”œâ”€ If event.payload: use directly                  â”‚    â”‚        â”‚
â”‚  â”‚     â””â”€ If event.template_code:                         â”‚    â”‚        â”‚
â”‚  â”‚        â”œâ”€ Call Template Service                         â”‚    â”‚        â”‚
â”‚  â”‚        â”œâ”€ Render with variables                         â”‚    â”‚        â”‚
â”‚  â”‚        â””â”€ Return resolved payload                       â”‚    â”‚        â”‚
â”‚  â”‚  7. Send to FCM (Firebase Cloud Messaging)             â”‚    â”‚        â”‚
â”‚  â”‚  8. Handle success/retry/DLQ                           â”‚    â”‚        â”‚
â”‚  â”‚  9. Ack/Nack message to RabbitMQ                       â”‚    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â”œâ”€ If template_code â†’ fetch template:                       â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â”‚ GET /templates/{template_code}?language=en                â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â–¼ HTTP Request                                              â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
â”‚  â”‚        TEMPLATE SERVICE                                 â”‚   â”‚        â”‚
â”‚  â”‚  (Separate microservice - not in push_service repo)     â”‚   â”‚        â”‚
â”‚  â”‚                                                          â”‚   â”‚        â”‚
â”‚  â”‚  GET /templates/{template_code}                         â”‚   â”‚        â”‚
â”‚  â”‚  Response:                                              â”‚   â”‚        â”‚
â”‚  â”‚  {                                                      â”‚   â”‚        â”‚
â”‚  â”‚    "template_id": "welcome_v1",                         â”‚   â”‚        â”‚
â”‚  â”‚    "content": {                                         â”‚   â”‚        â”‚
â”‚  â”‚      "title": "Welcome, {{name}}!",                     â”‚   â”‚        â”‚
â”‚  â”‚      "body": "Thanks for joining {{platform}}.",        â”‚   â”‚        â”‚
â”‚  â”‚      "data": {"link": "{{link}}"}                       â”‚   â”‚        â”‚
â”‚  â”‚    },                                                   â”‚   â”‚        â”‚
â”‚  â”‚    "language": "en",                                    â”‚   â”‚        â”‚
â”‚  â”‚    "version": 1                                         â”‚   â”‚        â”‚
â”‚  â”‚  }                                                      â”‚   â”‚        â”‚
â”‚  â”‚                                                          â”‚   â”‚        â”‚
â”‚  â”‚  Storage: PostgreSQL + Redis cache                      â”‚   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
â”‚      â”‚ HTTP Response                                             â”‚        â”‚
â”‚      â”‚ (template content)                                        â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â”‚ core/template_resolver.py:                               â”‚        â”‚
â”‚      â”‚ â”œâ”€ Fetch template from Template Service                  â”‚        â”‚
â”‚      â”‚ â”œâ”€ Render: {{name}}â†’Alice, {{platform}}â†’iOS, etc.       â”‚        â”‚
â”‚      â”‚ â””â”€ Return resolved payload:                              â”‚        â”‚
â”‚      â”‚    {title: "Welcome, Alice!", body: "...", data: {...}} â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â–¼                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
â”‚  â”‚        FCM (Firebase Cloud Messaging)                   â”‚   â”‚        â”‚
â”‚  â”‚  (Google push provider - external service)              â”‚   â”‚        â”‚
â”‚  â”‚                                                          â”‚   â”‚        â”‚
â”‚  â”‚  Send notification with:                                â”‚   â”‚        â”‚
â”‚  â”‚  - token: "FCM_TOKEN_xyz" (device token)               â”‚   â”‚        â”‚
â”‚  â”‚  - title: "Welcome, Alice!"                             â”‚   â”‚        â”‚
â”‚  â”‚  - body: "Thanks for joining iOS."                      â”‚   â”‚        â”‚
â”‚  â”‚  - data: {"link": "https://..."}                        â”‚   â”‚        â”‚
â”‚  â”‚                                                          â”‚   â”‚        â”‚
â”‚  â”‚  Response: Message ID or error                          â”‚   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
â”‚      â”‚                                                            â”‚        â”‚
â”‚      â”‚ success?                                                   â”‚        â”‚
â”‚      â”œâ”€ Yes â”€â”€â–º âœ… Log success, ack message                     â”‚        â”‚
â”‚      â””â”€ No â”€â”€â”€â–º Retry with exponential backoff                  â”‚        â”‚
â”‚                 If max retries exceeded â†’ move to failed.queue   â”‚        â”‚
â”‚                                                                  â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚        â”‚
â”‚  â”‚  REDIS CACHE     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”œâ”€ Idempotency  â”‚  (Idempotency keys, rate limits,
â”‚  â”‚  â”œâ”€ Rate limits  â”‚   circuit state, token cache)
â”‚  â”‚  â”œâ”€ Circuit      â”‚
â”‚  â”‚  â””â”€ Tokens       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MESSAGE FLOW (Template Code Path):

  Event: {event_id, user_id, template_code: "welcome_v1", variables: {...}}
         â”‚
         â”œâ”€ 1. Idempotency: Set "push:event:{event_id}" in Redis (NX=true)
         â”‚
         â”œâ”€ 2. Token lookup: Get "push:token:user:{user_id}" from Redis
         â”‚
         â”œâ”€ 3. Rate limit: Increment "push:rate:{user_id}" counter
         â”‚
         â”œâ”€ 4. Circuit check: Check "circuit:fcm:open_until" in Redis
         â”‚     If open: schedule retry, ack, return
         â”‚
         â”œâ”€ 5. RESOLVE: Call Template Service HTTP
         â”‚     GET /templates/welcome_v1
         â”‚     Response: {content: {title: "Hello, {{name}}!", ...}}
         â”‚
         â”œâ”€ 6. RENDER: Substitute variables
         â”‚     {title: "Hello, Alice!", ...}
         â”‚
         â”œâ”€ 7. SEND: Call FCM with rendered payload
         â”‚
         â”œâ”€ 8. If success:
         â”‚     â””â”€ Reset circuit counter
         â”‚     â””â”€ Ack message
         â”‚
         â””â”€ 9. If failure:
              â”œâ”€ Increment circuit failure counter
              â”œâ”€ If failures >= 5 â†’ open circuit
              â”œâ”€ Schedule retry (exponential backoff)
              â”œâ”€ If retries >= 3 â†’ move to failed.queue
              â””â”€ Ack original message

---

KEY IMPROVEMENTS:

âœ… Flexibility: Template Service team can manage templates independently
âœ… Reusability: Same template used for multiple notification requests
âœ… Multi-language: Templates translated, Push Service requests correct language
âœ… Decoupling: API Gateway doesn't need to know template details
âœ… Performance: Inline payloads bypass Template Service for fast path
âœ… Resilience: Circuit breaker, retries, DLQ for failed messages

---

INTEGRATION CHECKLIST:

For API Gateway to use template path:
  â–¡ Decide: inline payload OR template_code for each notification type
  â–¡ Publish events with template_code + variables to push.queue
  â–¡ Variables must match template placeholders

For Template Service to support Push Service:
  â–¡ Implement GET /templates/{template_code}?language=en endpoint
  â–¡ Store templates with language variants
  â–¡ Return content with {{placeholder}} format
  â–¡ Add response caching (Redis TTL 1+ hour)

For Push Service (You):
  â–¡ Set TEMPLATE_SERVICE_URL env var (default: http://template_service:8002)
  â–¡ Run tests: pytest test_template_resolver.py
  â–¡ Monitor template resolution time in logs
  â–¡ Add Prometheus metrics (optional)
